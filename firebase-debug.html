<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 진단 도구</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-card {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .status-success { border-color: #28a745; background: #d4edda; }
        .status-error { border-color: #dc3545; background: #f8d7da; }
        .status-warning { border-color: #ffc107; background: #fff3cd; }
        .status-info { border-color: #17a2b8; background: #d1ecf1; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn.danger { background: #dc3545; }
        .log-area {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 Firebase 완전 진단 도구</h1>
        <p>Firebase 연결 문제를 자세히 진단합니다.</p>

        <button class="btn" onclick="runFullDiagnosis()">전체 진단 실행</button>
        <button class="btn danger" onclick="clearLog()">로그 지우기</button>
    </div>

    <div class="container">
        <h2>📊 실시간 상태</h2>

        <div id="env-card" class="status-card status-info">
            <strong>🌐 환경 정보:</strong> <span id="env-text">확인 중...</span>
        </div>

        <div id="sdk-card" class="status-card status-info">
            <strong>📦 Firebase SDK:</strong> <span id="sdk-text">확인 중...</span>
        </div>

        <div id="config-card" class="status-card status-info">
            <strong>⚙️ Firebase 설정:</strong> <span id="config-text">확인 중...</span>
        </div>

        <div id="auth-card" class="status-card status-info">
            <strong>🔐 Firebase Auth:</strong> <span id="auth-text">확인 중...</span>
        </div>

        <div id="firestore-card" class="status-card status-info">
            <strong>🗄️ Firestore:</strong> <span id="firestore-text">확인 중...</span>
        </div>
    </div>

    <div class="container">
        <h2>🔍 상세 진단 로그</h2>
        <div id="log" class="log-area">진단 시작 대기 중...</div>

        <div id="summary" class="summary" style="display: none;">
            <h3>📋 진단 요약</h3>
            <div id="summary-content"></div>
        </div>
    </div>

    <!-- Firebase SDK 로딩 -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        const log = document.getElementById('log');
        const summary = document.getElementById('summary');
        const summaryContent = document.getElementById('summary-content');

        let diagnostics = {
            environment: { status: 'pending', details: {} },
            sdk: { status: 'pending', details: {} },
            config: { status: 'pending', details: {} },
            auth: { status: 'pending', details: {} },
            firestore: { status: 'pending', details: {} }
        };

        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌ ERROR' :
                          type === 'success' ? '✅ SUCCESS' :
                          type === 'warning' ? '⚠️ WARNING' :
                          'ℹ️ INFO';

            log.textContent += `[${timestamp}] ${prefix}: ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function updateCard(cardId, textId, status, message) {
            const card = document.getElementById(cardId);
            const text = document.getElementById(textId);
            card.className = `status-card status-${status}`;
            text.textContent = message;
        }

        function clearLog() {
            log.textContent = '';
            summary.style.display = 'none';
        }

        async function checkEnvironment() {
            logMessage('=== 환경 정보 확인 ===');

            const env = {
                url: window.location.href,
                protocol: window.location.protocol,
                host: window.location.host,
                userAgent: navigator.userAgent,
                online: navigator.onLine
            };

            logMessage(`URL: ${env.url}`);
            logMessage(`프로토콜: ${env.protocol}`);
            logMessage(`호스트: ${env.host}`);
            logMessage(`온라인 상태: ${env.online}`);
            logMessage(`브라우저: ${env.userAgent.split(' ').pop()}`);

            diagnostics.environment = {
                status: 'success',
                details: env
            };

            updateCard('env-card', 'env-text', 'success',
                `${env.protocol}//${env.host} (온라인: ${env.online})`);
        }

        async function checkSDK() {
            logMessage('=== Firebase SDK 확인 ===');

            const firebaseExists = typeof firebase !== 'undefined';
            logMessage(`Firebase 객체 존재: ${firebaseExists}`);

            if (firebaseExists) {
                logMessage(`Firebase SDK 버전: ${firebase.SDK_VERSION}`);
                logMessage(`기존 Firebase 앱: ${firebase.apps.length}개`);

                // 로드된 스크립트 확인
                const scripts = Array.from(document.querySelectorAll('script[src]'));
                const firebaseScripts = scripts.filter(s => s.src.includes('firebase'));
                logMessage(`로드된 Firebase 스크립트: ${firebaseScripts.length}개`);

                firebaseScripts.forEach((script, i) => {
                    logMessage(`  ${i + 1}. ${script.src}`);
                });

                diagnostics.sdk = {
                    status: 'success',
                    details: {
                        version: firebase.SDK_VERSION,
                        apps: firebase.apps.length,
                        scripts: firebaseScripts.length
                    }
                };

                updateCard('sdk-card', 'sdk-text', 'success',
                    `v${firebase.SDK_VERSION} (${firebaseScripts.length}개 스크립트)`);
            } else {
                logMessage('Firebase SDK가 로드되지 않았습니다', 'error');
                logMessage('가능한 원인: 네트워크 문제, CDN 차단, 스크립트 오류', 'warning');

                diagnostics.sdk = {
                    status: 'error',
                    details: { error: 'SDK not loaded' }
                };

                updateCard('sdk-card', 'sdk-text', 'error', 'SDK 로드 실패');
            }

            return firebaseExists;
        }

        async function checkConfig() {
            logMessage('=== Firebase 설정 확인 ===');

            try {
                // Firebase 설정 (firebase-config.js에서 가져옴)
                const config = {
                    apiKey: "AIzaSyAW1hX726N0EQv6uW0_6yUyGCsWylYlEEI",
                    authDomain: "lms-26168.firebaseapp.com",
                    projectId: "lms-26168",
                    appId: "1:264403082469:web:74f35eaec8e2c2f322080c"
                };

                logMessage(`프로젝트 ID: ${config.projectId}`);
                logMessage(`인증 도메인: ${config.authDomain}`);
                logMessage(`API 키: ${config.apiKey.substring(0, 10)}...`);
                logMessage(`앱 ID: ${config.appId}`);

                // Firebase 앱 초기화 시도
                let app;
                if (firebase.apps.length === 0) {
                    app = firebase.initializeApp(config);
                    logMessage('Firebase 앱 초기화 완료', 'success');
                } else {
                    app = firebase.app();
                    logMessage('기존 Firebase 앱 사용', 'success');
                }

                diagnostics.config = {
                    status: 'success',
                    details: { projectId: config.projectId }
                };

                updateCard('config-card', 'config-text', 'success',
                    `프로젝트: ${config.projectId}`);

                return true;
            } catch (error) {
                logMessage(`Firebase 설정 오류: ${error.message}`, 'error');

                diagnostics.config = {
                    status: 'error',
                    details: { error: error.message }
                };

                updateCard('config-card', 'config-text', 'error', `오류: ${error.message}`);
                return false;
            }
        }

        async function checkAuth() {
            logMessage('=== Firebase Auth 확인 ===');

            try {
                const auth = firebase.auth();
                logMessage('Firebase Auth 초기화 성공', 'success');

                // 현재 사용자 확인
                const user = auth.currentUser;
                if (user) {
                    logMessage(`현재 로그인된 사용자: ${user.email}`, 'success');
                } else {
                    logMessage('현재 로그인된 사용자 없음', 'info');
                }

                diagnostics.auth = {
                    status: 'success',
                    details: { user: user ? user.email : null }
                };

                updateCard('auth-card', 'auth-text', 'success',
                    user ? `로그인됨: ${user.email}` : '서비스 정상 (로그인 안됨)');

                return true;
            } catch (error) {
                logMessage(`Firebase Auth 오류: ${error.message}`, 'error');

                diagnostics.auth = {
                    status: 'error',
                    details: { error: error.message }
                };

                updateCard('auth-card', 'auth-text', 'error', `오류: ${error.message}`);
                return false;
            }
        }

        async function checkFirestore() {
            logMessage('=== Firestore 확인 ===');

            try {
                const db = firebase.firestore();
                logMessage('Firestore 초기화 성공', 'success');

                // 네트워크 연결 테스트
                await db.enableNetwork();
                logMessage('Firestore 네트워크 연결 성공', 'success');

                // 간단한 읽기 테스트
                try {
                    const snapshot = await db.collection('connection-test').limit(1).get();
                    logMessage(`Firestore 읽기 테스트 성공 (${snapshot.size}개 문서)`, 'success');

                    diagnostics.firestore = {
                        status: 'success',
                        details: { documents: snapshot.size }
                    };

                    updateCard('firestore-card', 'firestore-text', 'success',
                        `연결됨 (${snapshot.size}개 문서)`);
                } catch (readError) {
                    logMessage(`Firestore 읽기 오류: ${readError.code} - ${readError.message}`, 'warning');

                    if (readError.code === 'permission-denied') {
                        logMessage('권한 오류 - Firebase 보안 규칙을 확인하세요', 'warning');
                    }

                    diagnostics.firestore = {
                        status: 'warning',
                        details: { error: readError.code }
                    };

                    updateCard('firestore-card', 'firestore-text', 'warning',
                        `연결됨 (권한 문제: ${readError.code})`);
                }

                return true;
            } catch (error) {
                logMessage(`Firestore 오류: ${error.message}`, 'error');

                diagnostics.firestore = {
                    status: 'error',
                    details: { error: error.message }
                };

                updateCard('firestore-card', 'firestore-text', 'error', `오류: ${error.message}`);
                return false;
            }
        }

        async function generateSummary() {
            logMessage('=== 진단 완료 ===');

            const results = Object.values(diagnostics);
            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            const warningCount = results.filter(r => r.status === 'warning').length;

            logMessage(`성공: ${successCount}, 경고: ${warningCount}, 오류: ${errorCount}`);

            let summaryHtml = '<ul>';

            if (diagnostics.environment.status === 'success') {
                summaryHtml += '<li>✅ 환경: 정상</li>';
            }

            if (diagnostics.sdk.status === 'success') {
                summaryHtml += '<li>✅ Firebase SDK: 로드됨</li>';
            } else {
                summaryHtml += '<li>❌ Firebase SDK: 로드 실패 - 네트워크 확인 필요</li>';
            }

            if (diagnostics.config.status === 'success') {
                summaryHtml += '<li>✅ Firebase 설정: 정상</li>';
            } else {
                summaryHtml += '<li>❌ Firebase 설정: 오류</li>';
            }

            if (diagnostics.auth.status === 'success') {
                summaryHtml += '<li>✅ Firebase Auth: 정상</li>';
            } else {
                summaryHtml += '<li>❌ Firebase Auth: 오류</li>';
            }

            if (diagnostics.firestore.status === 'success') {
                summaryHtml += '<li>✅ Firestore: 정상</li>';
            } else if (diagnostics.firestore.status === 'warning') {
                summaryHtml += '<li>⚠️ Firestore: 연결됨 (권한 문제)</li>';
            } else {
                summaryHtml += '<li>❌ Firestore: 연결 실패</li>';
            }

            summaryHtml += '</ul>';

            if (errorCount === 0) {
                summaryHtml += '<p><strong>🎉 모든 Firebase 서비스가 정상 작동합니다!</strong></p>';
            } else {
                summaryHtml += '<p><strong>⚠️ 일부 서비스에 문제가 있습니다. 위의 로그를 확인하세요.</strong></p>';
            }

            summaryContent.innerHTML = summaryHtml;
            summary.style.display = 'block';
        }

        async function runFullDiagnosis() {
            clearLog();
            logMessage('🚀 Firebase 전체 진단 시작');

            await checkEnvironment();

            const sdkOk = await checkSDK();
            if (!sdkOk) {
                await generateSummary();
                return;
            }

            const configOk = await checkConfig();
            if (!configOk) {
                await generateSummary();
                return;
            }

            await checkAuth();
            await checkFirestore();
            await generateSummary();

            logMessage('🏁 전체 진단 완료');
        }

        // 페이지 로드 시 자동 실행
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runFullDiagnosis, 1000);
        });
    </script>
</body>
</html>